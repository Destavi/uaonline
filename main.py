import discord
from discord.ext import commands
from panel import ComplaintPanel
from moderation import Moderation
from roles import RoleRequest
from applications_publisher import AppPublisher
from config import TOKEN
from services.database import init_db
import asyncio
import os
import threading
from http.server import HTTPServer, BaseHTTPRequestHandler

# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
init_db()

intents = discord.Intents.default()
intents.members = True          
intents.message_content = True  
bot = commands.Bot(command_prefix="!", intents=intents)

# –ü—Ä–æ—Å—Ç–∏–π HTTP-—Å–µ—Ä–≤–µ—Ä –¥–ª—è Health Check (–ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–ª—è Render)
class HealthCheckHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.send_header('Content-type', 'text/plain')
        self.end_headers()
        self.wfile.write(b"OK")

    def log_message(self, format, *args):
        return # –í–∏–º–∏–∫–∞—î–º–æ –∑–∞–π–≤–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—ñ–≤

def run_health_check():
    port = int(os.environ.get("PORT", 8080))
    server = HTTPServer(('0.0.0.0', port), HealthCheckHandler)
    print(f"üì° Health Check —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–∏–π –Ω–∞ –ø–æ—Ä—Ç—É {port}")
    server.serve_forever()

@bot.event
async def on_ready():
    print("====================================")
    print(f"‚úÖ –ë–æ—Ç –ó–ê–ü–£–©–ï–ù–ò–ô —è–∫ {bot.user}")
    print("====================================")
    try:
        await bot.tree.sync()
        print("‚úÖ Slash-–∫–æ–º–∞–Ω–¥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω—ñ")
    except Exception as e:
        print(f"‚ùå –ü–æ–º–∏–ª–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó slash-–∫–æ–º–∞–Ω–¥: {e}")

async def setup():
    await bot.add_cog(ComplaintPanel(bot))
    await bot.add_cog(Moderation(bot))
    await bot.add_cog(RoleRequest(bot))
    await bot.add_cog(AppPublisher(bot))

async def main():
    async with bot:
        await setup()
        await bot.start(TOKEN)

if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫–∞—î–º–æ health check –≤ –æ–∫—Ä–µ–º–æ–º—É –ø–æ—Ç–æ—Ü—ñ
    threading.Thread(target=run_health_check, daemon=True).start()
    
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("üõë –ë–æ—Ç –∑—É–ø–∏–Ω–µ–Ω–∏–π")
    except Exception as e:
        print(f"‚ùå –ö–†–ò–¢–ò–ß–ù–ê –ü–û–ú–ò–õ–ö–ê: {e}")

